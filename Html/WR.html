<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart WR Hybrid - SVG Ring + Canvas Labels</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .container-chart-wr {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(20, 20, 20, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .title-pairs-wr {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: rgb(245, 245, 245);
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            aspect-ratio: 1 / 0.84;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #wrChartSVG {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-90deg);
            width: 200px;
            height: 200px;
            z-index: 1;
        }

        #donutChart {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
    </style>
</head>
<body>
    <div class="container-chart-wr">
        <p class="title-pairs-wr">Chart Winrate</p>
        <div class="chart-wrapper">
            <svg id="wrChartSVG" viewBox="0 0 200 200">
                <defs>
                    <linearGradient id="winGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#00fff2;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#4dd4ac;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="loseGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#e22222;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#ff0000;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="missedGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#cfcfcf;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#ffffff;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle id="winSegment" cx="100" cy="100" r="82.5" 
                        fill="none" stroke="url(#winGradient)" stroke-width="35"
                        style="filter: drop-shadow(0px 4px 12px rgba(0, 0, 0, 0.15)); transition: stroke-dasharray 0.8s ease, stroke-dashoffset 0.8s ease;">
                </circle>
                <circle id="loseSegment" cx="100" cy="100" r="82.5" 
                        fill="none" stroke="url(#loseGradient)" stroke-width="35"
                        style="filter: drop-shadow(0px 4px 12px rgba(0, 0, 0, 0.15)); transition: stroke-dasharray 0.8s ease, stroke-dashoffset 0.8s ease;">
                </circle>
                <circle id="missedSegment" cx="100" cy="100" r="82.5" 
                        fill="none" stroke="url(#missedGradient)" stroke-width="35"
                        style="filter: drop-shadow(0px 4px 12px rgba(0, 0, 0, 0.15)); transition: stroke-dasharray 0.8s ease, stroke-dashoffset 0.8s ease;">
                </circle>
            </svg>
            <canvas id="donutChart"></canvas>
        </div>
    </div>

    <script>
        async function getDB() {
            return [
                { Result: "Profit" },
                { Result: "Profit" },
                { Result: "Profit" },
                { Result: "Profit" },
                { Result: "Loss" },
                { Result: "Loss" },
                { Result: "Loss" },
                { Result: "Loss" },
                { Result: "Loss" },
                { Result: "Loss" },
                { Result: "Missed" },
                { Result: "Missed" },
                { Result: "Missed" },
                { Result: "Missed" },
                { Result: "Missed" },
                { Result: "Missed" }
            ];
        }

        const canvasWrChart = document.getElementById('donutChart');
        const ctxWrChart = canvasWrChart.getContext('2d');
        const circumferenceSVG = 2 * Math.PI * 82.5;

        function resizeWrChart() {
            const parent = canvasWrChart.parentElement;
            const parentWidth = parent.clientWidth;
            const parentHeight = parent.clientHeight;
            const dpr = window.devicePixelRatio || 1;

            canvasWrChart.style.width = parentWidth + 'px';
            canvasWrChart.style.height = parentHeight + 'px';

            canvasWrChart.width = Math.round(parentWidth * dpr);
            canvasWrChart.height = Math.round(parentHeight * dpr);

            ctxWrChart.setTransform(1, 0, 0, 1, 0, 0);
            ctxWrChart.scale(dpr, dpr);

            const centerX = parentWidth / 2;
            const centerY = parentHeight / 2;

            ctxWrChart.imageSmoothingEnabled = false;

            return { centerX, centerY };
        }

        let { centerX, centerY } = resizeWrChart();
        window.addEventListener('resize', () => {
            const newCenter = resizeWrChart();
            centerX = newCenter.centerX;
            centerY = newCenter.centerY;

            if (dataWrChart.length > 0) {
                startTime = null;
                updateSVGRing();
                requestAnimationFrame(animateWrChart);
            }
        });

        const radius = 100;
        const holeRadius = 65;

        let dataWrChart = [];
        let total = 0;

        let animationProgress = 0;
        const animationDuration = 500;
        let startTime = null;

        function updateSVGRing() {
            if (total === 0) return;

            const winPercentage = (dataWrChart[0].value / total) * 100;
            const losePercentage = (dataWrChart[1].value / total) * 100;
            const missedPercentage = (dataWrChart[2].value / total) * 100;

            const winLength = (winPercentage / 100) * circumferenceSVG;
            const loseLength = (losePercentage / 100) * circumferenceSVG;
            const missedLength = (missedPercentage / 100) * circumferenceSVG;

            const winSegment = document.getElementById('winSegment');
            const loseSegment = document.getElementById('loseSegment');
            const missedSegment = document.getElementById('missedSegment');

            if (!winSegment || !loseSegment || !missedSegment) return;

            winSegment.style.strokeDasharray = `${winLength} ${circumferenceSVG}`;
            winSegment.style.strokeDashoffset = '0';

            loseSegment.style.strokeDasharray = `${loseLength} ${circumferenceSVG}`;
            loseSegment.style.strokeDashoffset = -winLength;

            missedSegment.style.strokeDasharray = `${missedLength} ${circumferenceSVG}`;
            missedSegment.style.strokeDashoffset = -(winLength + loseLength);
        }

        async function loadWrChartData() {
            try {
                const data = await getDB();

                const counts = { Profite: 0, Loss: 0, Missed: 0 };
                data.forEach(item => {
                    if (item.Result === "Profit") counts.Profite++;
                    else if (item.Result === "Loss") counts.Loss++;
                    else if (item.Result === "Missed") counts.Missed++;
                });

                dataWrChart = [
                    { label: 'Win', value: counts.Profite, color1: '#4dd4ac', color2: '#4dd4ac' },
                    { label: 'Lose', value: counts.Loss, color1: '#ff0000', color2: '#ff0000' },
                    { label: 'Missed', value: counts.Missed, color1: '#ffffff', color2: '#ffffff' }
                ];

                total = dataWrChart.reduce((sum, item) => sum + item.value, 0);

                updateSVGRing();
                requestAnimationFrame(animateWrChart);
            } catch (err) {
                console.error("Gagal memuat data WR:", err);
            }
        }

        function drawLabelWrChart(item, startAngle, endAngle, delay) {
            if (item.value === 0) return;

            const progress = Math.max(0, Math.min(1, (animationProgress - delay) / 500));
            if (progress <= 0) return;

            const midAngle = startAngle + (endAngle - startAngle) / 2;
            const percentage = ((item.value / total) * 100).toFixed(1) + '%';

            const lineStartX = centerX + Math.cos(midAngle) * radius;
            const lineStartY = centerY + Math.sin(midAngle) * radius;

            let lineMidX, lineMidY, lineEndX, lineEndY, textX, align;
            const isRightSide = Math.cos(midAngle) > 0;
            const isBottom = Math.sin(midAngle) > 0;

            const offsetX = 25;
            const offsetY = 30;

            if (isRightSide) {
                lineMidX = lineStartX + offsetX;
                lineMidY = lineStartY + (isBottom ? offsetY : -offsetY);
                lineEndX = canvasWrChart.width - 40;
                lineEndY = lineMidY;
                textX = lineEndX - 10;
                align = 'right';
            } else {
                lineMidX = lineStartX - offsetX;
                lineMidY = lineStartY + (isBottom ? offsetY : -offsetY);
                lineEndX = 40;
                lineEndY = lineMidY;
                textX = lineEndX + 10;
                align = 'left';
            }

            ctxWrChart.strokeStyle = item.color2;
            ctxWrChart.lineWidth = 2;
            ctxWrChart.globalAlpha = progress;
            ctxWrChart.beginPath();
            ctxWrChart.moveTo(lineStartX, lineStartY);
            ctxWrChart.lineTo(lineMidX, lineMidY);
            ctxWrChart.lineTo(lineEndX, lineEndY);
            ctxWrChart.stroke();

            ctxWrChart.fillStyle = item.color1;
            ctxWrChart.beginPath();
            ctxWrChart.arc(lineEndX, lineEndY, 4, 0, Math.PI * 2);
            ctxWrChart.fill();

            ctxWrChart.textAlign = align;
            ctxWrChart.fillStyle = 'rgb(245, 245, 245)';
            ctxWrChart.font = 'bold 16px Inter';
            ctxWrChart.fillText(percentage, textX, lineEndY - 10);

            ctxWrChart.fillStyle = 'rgb(163, 163, 163)';
            ctxWrChart.font = '600 12px Inter';
            ctxWrChart.fillText(item.label, textX, lineEndY + 18);

            ctxWrChart.globalAlpha = 1;
        }

        function drawCenterText() {
            const progress = Math.max(0, Math.min(1, (animationProgress - 1200) / 300));
            if (progress <= 0) return;

            ctxWrChart.globalAlpha = progress;
            ctxWrChart.fillStyle = 'rgb(245, 245, 245)';
            ctxWrChart.font = 'bold 32px Inter';
            ctxWrChart.textAlign = 'center';
            ctxWrChart.fillText(total.toLocaleString('id-ID'), centerX, centerY + 10);
            ctxWrChart.globalAlpha = 1;
        }

        function animateWrChart(timestamp) {
            if (!startTime) startTime = timestamp;
            animationProgress = timestamp - startTime;

            ctxWrChart.clearRect(0, 0, canvasWrChart.width, canvasWrChart.height);

            let currentAngle = -Math.PI / 2;

            dataWrChart.forEach((item, index) => {
                const sliceAngle = (item.value / total) * Math.PI * 2;
                const itemDelay = index * 300;
                const itemProgress = Math.max(0, Math.min(1, (animationProgress - itemDelay) / 800));

                if (itemProgress >= 0.8) {
                    drawLabelWrChart(item, currentAngle, currentAngle + sliceAngle, 1000 + index * 300);
                }

                currentAngle += sliceAngle;
            });

            drawCenterText();

            if (animationProgress < animationDuration + 1500) {
                requestAnimationFrame(animateWrChart);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadWrChartData);
        } else {
            loadWrChartData();
        }
    </script>
</body>
</html>